<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Premium Movie Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* (kept styling very close to your original) */
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .loading-spinner{animation:spin 1s linear infinite;}
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;background:#000;border-radius:0.75rem;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);}
    .video-container video{position:absolute;top:0;left:0;width:100%;height:100%;}
    .controls-container{transition:opacity .3s ease;}
    .progress-container{height:5px;background:rgba(255,255,255,.2);cursor:pointer;}
    .progress-bar{height:100%;background:#f59e0b;transition:width .1s;}
    .volume-container{width:0;transition:width .2s ease;overflow:hidden;}
    .volume-container.active{width:100px;}
    .settings-menu{transform:translateY(20px);opacity:0;transition:all .2s ease;pointer-events:none;}
    .settings-menu.active{transform:translateY(0);opacity:1;pointer-events:all;}
    .quality-option:hover,.speed-option:hover,.subtitle-option:hover{background-color:rgba(255,255,255,.1);}
    .tooltip{visibility:hidden;opacity:0;transition:opacity .3s;}
    .tooltip-parent:hover .tooltip{visibility:visible;opacity:1;}
    @media (max-width:768px){.controls-container{padding:.5rem}.control-btn{padding:.5rem}.volume-container{display:none}.mobile-volume{display:block}}
    body{background:#0b0b0b;color:#f3f4f6;font-family:Inter,Arial,Helvetica,sans-serif;padding:18px;}
    .header{width:100%;max-width:1100px;margin:0 auto 18px;display:flex;justify-content:space-between;align-items:center}
    .header h1{color:#f59e0b;margin:0}
    .header a{color:#94a3b8;text-decoration:none}
    .container{width:100%;max-width:1100px;margin:0 auto}
    .info-msg{margin-top:10px;color:#ffb4a2;font-size:13px;display:none}
  </style>
</head>
<body>
  <div class="header">
    <h1 id="movie-title">Movie Title</h1>
    <a href="index.html"><i class="fas fa-arrow-left" style="margin-right:6px"></i>Back</a>
  </div>

  <div class="container">
    <!-- Loading Overlay (absolute inside video-container) -->
    <div class="video-container" id="video-container">
      <div id="loading-overlay" style="position:absolute;inset:0;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;">
        <div class="loading-spinner" style="width:64px;height:64px;border:6px solid #2b2b2b;border-top-color:#f59e0b;border-radius:50%;margin-bottom:12px"></div>
        <div id="loading-text" style="color:#f59e0b;font-weight:600;margin-bottom:8px">Loading movie...</div>
        <div id="loading-details" style="color:#9ca3af;font-size:13px">Please wait while we prepare your viewing experience</div>
      </div>

      <video id="video" crossorigin="anonymous" playsinline></video>

      <!-- Custom Controls (kept intact from your original) -->
      <div id="controls-container" class="controls-container" style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg, rgba(0,0,0,0.75), transparent);padding:12px;opacity:1">
        <div class="progress-container" id="progress-container">
          <div class="progress-bar" id="progress-bar" style="width:0%"></div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="display:flex;align-items:center;gap:8px">
            <button id="play-pause" class="control-btn" style="background:none;border:none;color:white"><i class="fas fa-play" style="font-size:18px"></i></button>
            <button id="rewind" class="control-btn" title="Rewind 10s" style="background:none;border:none;color:white"><i class="fas fa-backward"></i></button>
            <button id="forward" class="control-btn" title="Forward 10s" style="background:none;border:none;color:white"><i class="fas fa-forward"></i></button>

            <div style="display:flex;align-items:center;gap:8px">
              <button id="volume-btn" class="control-btn" style="background:none;border:none;color:white"><i class="fas fa-volume-up"></i></button>
              <div id="volume-container" class="volume-container" style="display:flex;align-items:center">
                <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1" style="width:100px">
              </div>
            </div>

            <div style="color:#9ca3af;margin-left:8px" id="time-display">00:00 / 00:00</div>
          </div>

          <div style="display:flex;align-items:center;gap:8px">
            <div class="relative">
              <button id="speed-btn" class="control-btn" style="background:none;border:none;color:white">1x</button>
              <div id="speed-menu" class="settings-menu" style="position:absolute;bottom:100%;right:0;background:#1f2937;padding:6px;border-radius:6px;display:none">
                <div class="speed-option" data-speed="0.5">0.5x</div>
                <div class="speed-option" data-speed="0.75">0.75x</div>
                <div class="speed-option" data-speed="1">1x (Normal)</div>
                <div class="speed-option" data-speed="1.25">1.25x</div>
                <div class="speed-option" data-speed="1.5">1.5x</div>
                <div class="speed-option" data-speed="2">2x</div>
              </div>
            </div>

            <div class="relative">
              <button id="subtitle-btn" class="control-btn" style="background:none;border:none;color:white"><i class="fas fa-closed-captioning"></i></button>
              <div id="subtitle-menu" class="settings-menu" style="position:absolute;bottom:100%;right:0;background:#1f2937;padding:6px;border-radius:6px;display:none">
                <div class="subtitle-option" data-subtitle="none">None</div>
                <div class="subtitle-option" data-subtitle="en">English</div>
              </div>
            </div>

            <div class="relative">
              <button id="quality-btn" class="control-btn" style="background:none;border:none;color:white"><i class="fas fa-cog"></i></button>
              <div id="quality-menu" class="settings-menu" style="position:absolute;bottom:100%;right:0;background:#1f2937;padding:6px;border-radius:6px;display:none">
                <div class="quality-option" data-quality="auto">Auto</div>
                <div class="quality-option" data-quality="720">720p</div>
                <div class="quality-option" data-quality="480">480p</div>
                <div class="quality-option" data-quality="360">360p</div>
              </div>
            </div>

            <button id="fullscreen-btn" class="control-btn" style="background:none;border:none;color:white"><i class="fas fa-expand"></i></button>
          </div>
        </div>
      </div>
    </div>

    <div class="info-msg" id="info-msg"></div>
  </div>

  <script>
    /***********************
     * Helper: get raw video param (robust)
     ***********************/
    function getRawVideoParam() {
      // Try URLSearchParams first (standard)
      const params = new URLSearchParams(window.location.search);
      const p = params.get('video');
      if (p) return p; // usually decoded, when encoded by encodeURIComponent

      // Fallback: extract everything after first occurrence of "video="
      const href = window.location.href;
      const idx = href.indexOf('video=');
      if (idx === -1) return null;

      // take substring after 'video='
      let raw = href.substring(idx + 6); // everything after video=
      // If there are known parameter separators appearing later (e.g., &title=), trim them
      const cut = raw.search(/(&title=|&subtitle=|&autoplay=|&mode=|&utm_|#)/i);
      if (cut !== -1) raw = raw.substring(0, cut);

      // It might be percent encoded or not; try decodeURIComponent safely
      try {
        const dec = decodeURIComponent(raw);
        // If decode gives an empty/invalid result, fall back to raw
        if (dec && dec.length > 0) raw = dec;
      } catch (e) {
        // ignore decode errors and keep raw
      }

      // If raw contains spaces (from a '+' decoded wrongly), replace spaces back to '+'
      // (some sources put '+' chars that got turned into spaces)
      if (raw.includes(' ')) {
        // heuristic: if it looks like it should be a URL, restore pluses
        const maybeUrl = raw.replace(/ /g, '+');
        if (maybeUrl.startsWith('http') || maybeUrl.includes('.m3u8') || maybeUrl.includes('.mp4')) {
          raw = maybeUrl;
        }
      }

      return raw;
    }

    /***********************
     * DOM and state
     ***********************/
    const params = new URLSearchParams(window.location.search);
    const titleParam = params.get('title');
    const rawVideoParam = getRawVideoParam();
    const subtitleParam = params.get('subtitle') || null;
    const saveKey = `continue-${titleParam || 'video'}`;

    const video = document.getElementById('video');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const movieTitle = document.getElementById('movie-title');
    const videoContainer = document.getElementById('video-container');
    const controlsContainer = document.getElementById('controls-container');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const playPauseBtn = document.getElementById('play-pause');
    const rewindBtn = document.getElementById('rewind');
    const forwardBtn = document.getElementById('forward');
    const volumeBtn = document.getElementById('volume-btn');
    const volumeSlider = document.getElementById('volume-slider');
    const mobileVolumeSlider = null; // not present in this trimmed UI
    const volumeContainer = document.getElementById('volume-container');
    const speedBtn = document.getElementById('speed-btn');
    const speedMenu = document.getElementById('speed-menu');
    const subtitleBtn = document.getElementById('subtitle-btn');
    const subtitleMenu = document.getElementById('subtitle-menu');
    const qualityBtn = document.getElementById('quality-btn');
    const qualityMenu = document.getElementById('quality-menu');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const infoMsg = document.getElementById('info-msg');

    let isDraggingProgress = false;
    let hls = null;
    let dashPlayer = null;
    let lastVolume = 1;
    let settingsOpen = false;

    /***********************
     * Init
     ***********************/
    function initPlayer() {
      if (titleParam) movieTitle.textContent = titleParam;
      setupEventListeners();

      if (!rawVideoParam) {
        showLoading('No video provided');
        info('No ?video= parameter found in URL.');
        return;
      }

      // start loading
      loadVideo(rawVideoParam);
    }

    /***********************
     * Event wiring (controls)
     ***********************/
    function setupEventListeners() {
      // video events
      video.addEventListener('timeupdate', updateProgress);
      video.addEventListener('loadedmetadata', updateDuration);
      video.addEventListener('play', updatePlayPauseIcon);
      video.addEventListener('pause', updatePlayPauseIcon);
      video.addEventListener('volumechange', updateVolumeIcon);
      video.addEventListener('click', togglePlayPause);
      video.addEventListener('dblclick', toggleFullscreen);

      // controls
      playPauseBtn.addEventListener('click', togglePlayPause);
      rewindBtn.addEventListener('click', () => seek(-10));
      forwardBtn.addEventListener('click', () => seek(10));
      volumeBtn.addEventListener('click', toggleMute);
      volumeSlider.addEventListener('input', updateVolume);
      fullscreenBtn.addEventListener('click', toggleFullscreen);

      progressContainer.addEventListener('mousedown', startDraggingProgress);
      document.addEventListener('mousemove', dragProgress);
      document.addEventListener('mouseup', stopDraggingProgress);

      // menus
      speedBtn.addEventListener('click', () => toggleMenu(speedMenu));
      subtitleBtn.addEventListener('click', () => toggleMenu(subtitleMenu));
      qualityBtn.addEventListener('click', () => toggleMenu(qualityMenu));

      document.querySelectorAll('.speed-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const s = parseFloat(opt.dataset.speed);
          video.playbackRate = s;
          speedBtn.textContent = `${s}x`;
          speedMenu.style.display = 'none';
        });
      });

      document.querySelectorAll('.subtitle-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const sub = opt.dataset.subtitle;
          for (const t of video.textTracks) {
            t.mode = (sub !== 'none' && t.language === sub) ? 'showing' : 'hidden';
          }
          subtitleMenu.style.display = 'none';
        });
      });

      document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    /***********************
     * UI helpers
     ***********************/
    function showLoading(msg) {
      loadingOverlay.style.display = 'flex';
      loadingText.textContent = msg || 'Loading...';
    }
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }
    function info(text) {
      infoMsg.style.display = 'block';
      infoMsg.textContent = text;
      console.log('[player] ' + text);
    }
    function clearInfo() {
      infoMsg.style.display = 'none';
      infoMsg.textContent = '';
    }

    /***********************
     * Load video (universal + robust)
     ***********************/
    async function loadVideo(url) {
      clearInfo();

      // cleanup existing players
      if (hls) { try { hls.destroy(); } catch(e) {} hls = null; }
      if (dashPlayer) { try { dashPlayer.reset(); } catch(e) {} dashPlayer = null; }

      // remove previous tracks
      Array.from(video.querySelectorAll('track')).forEach(t => t.remove());

      // reset video element
      try {
        video.pause();
      } catch(e) {}
      try {
        video.removeAttribute('src');
        video.load();
      } catch(e) {}

      showLoading('Loading video...');

      // If the link is a .txt wrapper, fetch it and use its content
      try {
        if (url.toLowerCase().endsWith('.txt')) {
          const res = await fetch(url);
          if (!res.ok) { throw new Error('Failed to fetch .txt'); }
          url = (await res.text()).trim();
        }
      } catch (err) {
        hideLoading();
        info('Failed to fetch .txt wrapper: ' + err.message);
        return;
      }

      // Save the original (do not mutate when passing to Hls)
      const originalUrl = url;
      const lower = originalUrl.toLowerCase();

      // If subtitle param was passed, attach it (remove earlier tracks first)
      function attachSubtitles() {
        if (subtitleParam) {
          const track = document.createElement('track');
          track.kind = 'subtitles';
          track.label = 'English';
          track.srclang = 'en';
          track.src = subtitleParam;
          track.default = true;
          video.appendChild(track);
        }
      }

      // DASH (.mpd anywhere) — initialize dash.js
      if (lower.includes('.mpd')) {
        try {
          dashPlayer = dashjs.MediaPlayer().create();
          dashPlayer.initialize(video, originalUrl, true);
          attachSubtitles();
          hideLoading();
          video.play().catch(()=>{});
          return;
        } catch (err) {
          console.warn('dash init failed', err);
          // fallback to next option
        }
      }

      // Try HLS.js first (pass exact URL)
      if (Hls.isSupported()) {
        try {
          hls = new Hls({
            maxBufferLength: 30,
            maxMaxBufferLength: 600,
            maxBufferSize: 60 * 1000 * 1000,
            maxBufferHole: 0.5,
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 30
          });

          hls.loadSource(originalUrl); // PASS raw URL (keeps + and =)
          hls.attachMedia(video);

          const onManifest = (event, data) => {
            // Populate quality menu based on levels
            try {
              const qm = document.getElementById('quality-menu');
              qm.innerHTML = `<div class="quality-option" data-quality="auto">Auto</div>` +
                (data.levels ? data.levels.map(l => `<div class="quality-option" data-quality="${l.height}">${l.height}p</div>`).join('') : '');
              // reattach quality click listeners
              document.querySelectorAll('#quality-menu .quality-option').forEach(option => {
                option.addEventListener('click', () => {
                  const q = option.dataset.quality;
                  if (hls) {
                    if (q === 'auto') hls.currentLevel = -1;
                    else {
                      const levels = hls.levels;
                      for (let i = 0; i < levels.length; i++) {
                        if (levels[i].height <= parseInt(q)) { hls.currentLevel = i; break; }
                      }
                    }
                  }
                  qualityMenu.style.display = 'none';
                });
              });
            } catch(e){}
            attachSubtitles();
            hideLoading();
            // resume position if present
            try {
              const lastTime = localStorage.getItem(saveKey);
              if (lastTime) video.currentTime = parseFloat(lastTime);
            } catch(e){}
            video.play().catch(()=>{});
          };

          hls.on(Hls.Events.MANIFEST_PARSED, onManifest);

          hls.on(Hls.Events.ERROR, (event, data) => {
            console.warn('HLS error', data);
            if (data.fatal) {
              switch (data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                  showLoading('Network error — retrying...');
                  hls.startLoad();
                  break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                  showLoading('Media error — trying to recover...');
                  hls.recoverMediaError();
                  break;
                default:
                  // fatal other -> fallback to direct source
                  try { hls.destroy(); } catch(e) {}
                  hls = null;
                  // fallback to direct
                  video.src = originalUrl;
                  attachSubtitles();
                  video.addEventListener('loadedmetadata', function once() {
                    this.removeEventListener('loadedmetadata', once);
                    hideLoading();
                    try {
                      const lastTime = localStorage.getItem(saveKey);
                      if (lastTime) video.currentTime = parseFloat(lastTime);
                    } catch(e){}
                    video.play().catch(()=>{});
                  });
                  break;
              }
            }
          });

          return; // Hls is handling playback
        } catch (err) {
          console.warn('Hls init failed', err);
          // fallthrough to native attempt
        }
      }

      // Safari native HLS or direct playback fallback
      try {
        video.src = originalUrl;
        attachSubtitles();
        // on loadedmetadata: hide overlay and play
        const handler = function() {
          video.removeEventListener('loadedmetadata', handler);
          hideLoading();
          try {
            const lastTime = localStorage.getItem(saveKey);
            if (lastTime) video.currentTime = parseFloat(lastTime);
          } catch(e){}
          video.play().catch(()=>{});
        };
        video.addEventListener('loadedmetadata', handler);
        video.load();
      } catch (err) {
        hideLoading();
        info('Playback failed: ' + (err && err.message ? err.message : String(err)));
      }
    }

    /***********************
     * Controls & progress
     ***********************/
    function togglePlayPause(){ if (video.paused) video.play(); else video.pause(); }
    function updatePlayPauseIcon(){ playPauseBtn.querySelector('i').className = video.paused ? 'fas fa-play' : 'fas fa-pause'; }
    function seek(s){ try { video.currentTime = Math.max(0, Math.min(video.duration || Infinity, video.currentTime + s)); } catch(e){} }
    function toggleMute(){ if (video.volume > 0) { lastVolume = video.volume; video.volume = 0; volumeSlider.value = 0; } else { video.volume = lastVolume; volumeSlider.value = lastVolume; } }
    function updateVolume(){ const v = parseFloat(this.value || event.target.value); video.volume = v; lastVolume = v; }
    function updateVolumeIcon(){ /* optional more complex icon logic */ }

    function toggleFullscreen(){
      if (!document.fullscreenElement) videoContainer.requestFullscreen ? videoContainer.requestFullscreen() : null;
      else document.exitFullscreen ? document.exitFullscreen() : null;
    }

    // Progress dragging
    function startDraggingProgress(e){ e.preventDefault(); isDraggingProgress = true; updateProgressOnDrag(e); }
    function dragProgress(e){ if (isDraggingProgress) updateProgressOnDrag(e); }
    function stopDraggingProgress(){ isDraggingProgress = false; }
    function updateProgressOnDrag(e){
      const rect = progressContainer.getBoundingClientRect();
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      const pos = clientX - rect.left;
      const pct = Math.max(0, Math.min(1, pos / rect.width));
      progressBar.style.width = (pct * 100) + '%';
      if (!isNaN(video.duration) && video.duration > 0) video.currentTime = pct * video.duration;
    }

    function updateProgress(){
      if (!isDraggingProgress && video.duration) {
        const pct = (video.currentTime / video.duration) * 100;
        progressBar.style.width = pct + '%';
      }
      const cur = formatTime(video.currentTime || 0);
      const dur = formatTime(video.duration || 0);
      document.getElementById('time-display').textContent = `${cur} / ${dur}`;
      // save progress occasionally
      try {
        if (video.currentTime && (video.currentTime % 10 < 0.5)) {
          localStorage.setItem(saveKey, video.currentTime);
        }
      } catch(e) {}
    }
    function updateDuration(){ document.getElementById('time-display').textContent = `${formatTime(video.currentTime||0)} / ${formatTime(video.duration||0)}`; }
    function formatTime(s){ if (!s || isNaN(s)) return '0:00'; s = Math.floor(s); const m = Math.floor(s/60); const sec = s%60; return `${m}:${sec<10?'0'+sec:sec}`; }

    function toggleMenu(menu){ menu.style.display = (menu.style.display === 'block' ? 'none' : 'block'); }

    function handleKeyboardShortcuts(e){
      switch (e.key) {
        case ' ': e.preventDefault(); togglePlayPause(); break;
        case 'ArrowLeft': seek(-10); break;
        case 'ArrowRight': seek(10); break;
        case 'ArrowUp': video.volume = Math.min(1, (video.volume || 0) + 0.1); volumeSlider.value = video.volume; break;
        case 'ArrowDown': video.volume = Math.max(0, (video.volume || 0) - 0.1); volumeSlider.value = video.volume; break;
        case 'f': case 'F': toggleFullscreen(); break;
        case 'm': case 'M': toggleMute(); break;
      }
    }

    // Save on exit
    window.addEventListener('beforeunload', () => {
      try { if (!isNaN(video.currentTime)) localStorage.setItem(saveKey, video.currentTime); } catch(e){}
    });

    // Hide overlay when playable
    video.addEventListener('canplay', () => { try { hideLoading(); } catch(e){} });
    video.addEventListener('error', (ev) => {
      console.warn('video element error', ev);
      hideLoading();
      info('Playback error (see console).');
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', initPlayer);
  </script>
</body>
</html>
